// src/utils/waitForPlacement.js
export function waitForPlacement({
  agentBase = 'http://127.0.0.1:4321',
  thresholdKg = 0.2,
  stableMs   = 700,
  timeoutMs  = 15000
} = {}) {
  return new Promise((resolve, reject) => {
    let baseline = null;
    let since = null;
    const es = new EventSource(`${agentBase}/stream`);

    const done = (ok, val) => { try { es.close(); } catch {} ; ok ? resolve(val) : reject(val); };
    const to = setTimeout(() => done(false, new Error('Timeout čekání na váhu')), timeoutMs);

    es.onmessage = (e) => {
      try {
        const w = JSON.parse(e.data || '{}');
        const m = Number(w.measurement || 0);
        const stable = !!w.stable;

        if (baseline === null) { if (stable) baseline = m; return; }

        const placed = stable && (m - baseline) >= thresholdKg;
        if (placed) {
          if (!since) since = Date.now();
          if (Date.now() - since >= stableMs) {
            clearTimeout(to);
            done(true, { grossKg: m, baselineKg: baseline, netKg: m - baseline, units: w.unit || 'kg', raw: w });
          }
        } else {
          since = null;
        }
      } catch {}
    };

    es.onerror = () => { clearTimeout(to); done(false, new Error('Chyba streamu váhy')); };
  });
}
